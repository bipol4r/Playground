FROM tomcat:10.1-jdk11-openjdk-slim

WORKDIR /usr/local/tomcat/webapps-javaee/ROOT
RUN mkdir -p WEB-INF/classes WEB-INF/lib

ADD https://repo1.maven.org/maven2/org/apache/struts/struts2-core/6.0.0/struts2-core-6.0.0.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/org/freemarker/freemarker/2.3.31/freemarker-2.3.31.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/ognl/ognl/3.3.2/ognl-3.3.2.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/org/apache/commons/commons-lang3/3.12.0/commons-lang3-3.12.0.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/org/javassist/javassist/3.28.0-GA/javassist-3.28.0-GA.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-api/2.17.2/log4j-api-2.17.2.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.17.2/log4j-core-2.17.2.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/org/apache/commons/commons-text/1.9/commons-text-1.9.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/commons-fileupload/commons-fileupload/1.4/commons-fileupload-1.4.jar WEB-INF/lib/
ADD https://repo1.maven.org/maven2/commons-io/commons-io/2.11.0/commons-io-2.11.0.jar WEB-INF/lib/

COPY WEB-INF/web.xml WEB-INF/
COPY WEB-INF/struts.xml WEB-INF/classes/
COPY index.jsp .

COPY VulnerableAction.java /tmp/src/com/demo/action/VulnerableAction.java

RUN javac -cp ".:/usr/local/tomcat/lib/servlet-api.jar:WEB-INF/lib/*" \
    -d WEB-INF/classes \
    /tmp/src/com/demo/action/VulnerableAction.java

RUN rm -rf /tmp/*

EXPOSE 8080
CMD ["catalina.sh", "run"]