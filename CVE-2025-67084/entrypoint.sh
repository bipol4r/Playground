#!/bin/bash
set -e

echo "Waiting for MySQL..."
while ! mysqladmin ping -h"${MYSQL_HOST}" -u"${MYSQL_USER}" -p"${MYSQL_PASSWORD}" --skip-ssl --silent; do
     sleep 1
     done
echo "MySQL is ready!"

# Edit ipconfig.php
{
    echo "IP_URL=http://localhost:8080"
    echo "DB_HOSTNAME=${MYSQL_HOST}"
    echo "DB_USERNAME=${MYSQL_USER}"
    echo "DB_PASSWORD=${MYSQL_PASSWORD}"
    echo "DB_DATABASE=${MYSQL_DATABASE}"
    echo "REMOVE_INDEXPHP=true"
    echo "CI_ENV=development"
} >> /var/www/html/ipconfig.php

# Set permissions (intentionally insecure for vulnerability reproduction)
echo "Setting permissions..."
chown -R www-data:www-data /var/www/html \
     && chmod -R 755 /var/www/html \
     && chmod -R 777 /var/www/html/uploads \
     && chmod -R 777 /var/www/html/application/logs
# Delete .htaccess
echo "Deleting .htaccess file..."
find /var/www/html/uploads -name ".htaccess" -exec rm -f {} \;

# Start Apache
exec apache2-foreground